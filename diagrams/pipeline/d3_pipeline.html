<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Electrum Pipeline (D3.js)</title>

    <script src="https://d3js.org/d3.v7.min.js"></script>

    <style>
        body {
            background: #0a0f2f;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            color: white;
        }

        svg {
            width: 100vw;
            height: 100vh;
        }

        .node text {
            fill: white;
            font-size: 14px;
            pointer-events: none;
        }

        .link {
            stroke: url(#goldToSilver);
            stroke-width: 2px;
            marker-end: url(#arrowHead);
        }

        .link-label {
            fill: #d4af37;
            font-size: 12px;
        }

        .node circle {
            fill: #0f1a40;
            stroke: #d4af37;
            stroke-width: 2px;
        }
    </style>
</head>

<body>

<svg id="svg"></svg>

<script>

// Load JSON
d3.json("pipeline.json").then(data => {

    const width = window.innerWidth;
    const height = window.innerHeight;

    const svg = d3.select("svg");

    // Zoom capability
    const zoomGroup = svg.append("g");
    svg.call(d3.zoom().on("zoom", e => zoomGroup.attr("transform", e.transform)));

    // Define gradient (Electrum gold -> silver)
    const defs = svg.append("defs");

    const gradient = defs.append("linearGradient")
        .attr("id", "goldToSilver")
        .attr("x1", "0%")
        .attr("x2", "100%")
        .attr("y1", "0%")
        .attr("y2", "0%");

    gradient.append("stop")
        .attr("offset", "0%")
        .attr("stop-color", "#d4af37"); // gold

    gradient.append("stop")
        .attr("offset", "100%")
        .attr("stop-color", "#c0c0c0"); // silver

    // Arrowhead definition
    defs.append("marker")
        .attr("id", "arrowHead")
        .attr("viewBox", "0 0 12 12")
        .attr("refX", "16")
        .attr("refY", "6")
        .attr("markerWidth", "16")
        .attr("markerHeight", "16")
        .attr("markerUnits", "userSpaceOnUse")
        .attr("orient", "auto")
        .append("path")
        .attr("d", "M 0 0 L 12 6 L 0 12 z")
        .attr("fill", "#d4af37");

    // Force simulation
    const simulation = d3.forceSimulation(data.nodes)
        .force("link", d3.forceLink(data.links).id(d => d.id).distance(180))
        .force("charge", d3.forceManyBody().strength(-600))
        .force("center", d3.forceCenter(width / 2, height / 2));

    // Draw links
    const link = zoomGroup.selectAll(".link")
        .data(data.links)
        .enter()
        .append("line")
        .attr("class", "link");

    // Link labels
    const linkLabel = zoomGroup.selectAll(".link-label")
        .data(data.links)
        .enter()
        .append("text")
        .attr("class", "link-label")
        .text(d => d.label);

    // Draw nodes
    const node = zoomGroup.selectAll(".node")
        .data(data.nodes)
        .enter()
        .append("g")
        .attr("class", "node")
        .call(d3.drag()
            .on("start", dragStart)
            .on("drag", dragged)
            .on("end", dragEnd)
        );

    const tokenRadius = 28;
    const defaultRadius = 48;

    node.append("circle").attr("r", d => d.id.startsWith("Token") ? tokenRadius : defaultRadius);
    node.append("text")
        .attr("text-anchor", "middle")
        .attr("dy", ".35em")
        .text(d => d.id);

    simulation.on("tick", () => {
        link
            .attr("x1", d => d.source.x)
            .attr("y1", d => d.source.y)
            .attr("x2", d => d.target.x)
            .attr("y2", d => d.target.y);

        node.attr("transform", d => `translate(${d.x},${d.y})`);

        linkLabel
            .attr("x", d => (d.source.x + d.target.x) / 2)
            .attr("y", d => (d.source.y + d.target.y) / 2);
    });

    function dragStart(event, d) {
        if (!event.active) simulation.alphaTarget(0.3).restart();
        d.fx = d.x;
        d.fy = d.y;
    }

    function dragged(event, d) {
        d.fx = event.x;
        d.fy = event.y;
    }

    function dragEnd(event, d) {
        if (!event.active) simulation.alphaTarget(0);
        d.fx = null;
        d.fy = null;
    }
});

</script>

</body>
</html>
